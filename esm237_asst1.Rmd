---
title: "ESM237 - Assignment 1"
author: "Alex Ehrens, Pat Byrne"
date: "4/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# attach packages
library(tidyverse)
library(anytime)
library(lubridate)
library(tsibble)
library(feasts)
library(Kendall)
```

```{r}
# read in climate data
clim_data <- read.csv("chicago_climate_data.csv") %>% 
  select(c(STATION:DATE, PRCP, TMAX, TMIN))

### all of this was necessary just to parse dates
lubridates <- as.data.frame(mdy(clim_data$DATE)) %>% 
  rename(bad_dates = "mdy(clim_data$DATE)")

dates19 <- lubridates %>% 
  filter(bad_dates > "2022-01-01") %>% 
  mutate(correct_dates = (ymd(bad_dates)-years(100))) %>% 
  select(correct_dates)

dates_correct <- lubridates %>% 
  filter(bad_dates < "2022-01-01") %>% 
  rename(correct_dates = bad_dates)

date_sequence <- rbind(dates19, dates_correct)

clim_data <- clim_data %>% 
  mutate(date = date_sequence$correct_dates) %>% 
  mutate(month = as.numeric(format(date, "%m"))) %>% 
  mutate(year = as.numeric(format(date, "%Y"))) %>% 
  select(-DATE)
## FINALLY
```

```{r}
# average precipitation 
precip <- clim_data %>% 
  select(c(date, PRCP, month, year)) %>% 
  filter(year < 2021) %>%
  filter(PRCP > 1) %>% 
  mutate(decade = case_when(
    year < 1930 ~ 1,
    year >= 1930 & year < 1940 ~ 2,
    year >= 1940 & year < 1950 ~ 3,
    year >= 1950 & year < 1960 ~ 4,
    year >= 1960 & year < 1970 ~ 5,
    year >= 1970 & year < 1980 ~ 6,
    year >= 1980 & year < 1990 ~ 7,
    year >= 1990 & year < 2000 ~ 8,
    year >= 2000 & year < 2010 ~ 9,
    year >= 2010 & year < 2020 ~ 10,
    year >= 2020 ~ 11
  ))

precip_ts <- precip %>% 
  as_tsibble(key = NULL, index = date) %>% 
  fill_gaps()

# annual stats
precip_annual <- precip %>% 
  group_by(year) %>% 
  summarize(
    mean_precip = mean(PRCP, na.rm = TRUE),
    max_precip = max(PRCP, na.rm = TRUE),
    total_precip = sum(PRCP, na.rm = TRUE),
    count = n(),
    intensity = total_precip/count
  )

# annual plots - mean
ggplot(data = precip_annual)+
  geom_line(aes(x = year, y = mean_precip))

# annual plots - max
ggplot(data = precip_annual)+
  geom_line(aes(x = year, y = max_precip))

# annual plots - total
ggplot(data = precip_annual)+
  geom_line(aes(x = year, y = total_precip))

# annual plots - number of rainy days
ggplot(data = precip_annual)+
  geom_line(aes(x = year, y = count))
# NOTE - daily data is incomplete until mid-1940s, so should throw those years out for total count analysis

# monthly stats
precip_monthly <- precip %>% 
  group_by(decade, year, month) %>% 
  summarize(
    mean_precip = mean(PRCP, na.rm = TRUE),
    max_precip = max(PRCP, na.rm = TRUE),
    count = n()
  )

precip_monthly$year = factor(precip_monthly$year)
precip_monthly$decade = factor(precip_monthly$decade)

# monthly plots - mean
ggplot(data = precip_monthly)+
  geom_line(aes(x = month, y= mean_precip, color = year), show.legend = FALSE)+
  facet_wrap(~decade)

# monthly plots - mean, decadal
ggplot(data = precip_monthly)+
  geom_line(aes(x = month, y = mean_precip, color = decade))

# seasonplot - mean
precip_ts %>% 
  gg_season(y = PRCP)

# rainfall intensity
ggplot(data = precip_annual)+
  geom_line(aes(x = year, y = intensity))

```

```{r}
# Temperature 
temp <- clim_data %>% 
  select(c(date, TMAX, TMIN, month, year)) %>% 
  filter(year < 2021 & year > 1943) %>% 
  mutate(decade = case_when(
    year < 1930 ~ 1,
    year >= 1930 & year < 1940 ~ 2,
    year >= 1940 & year < 1950 ~ 3,
    year >= 1950 & year < 1960 ~ 4,
    year >= 1960 & year < 1970 ~ 5,
    year >= 1970 & year < 1980 ~ 6,
    year >= 1980 & year < 1990 ~ 7,
    year >= 1990 & year < 2000 ~ 8,
    year >= 2000 & year < 2010 ~ 9,
    year >= 2010 & year < 2020 ~ 10,
    year >= 2020 ~ 11
  ))

temp_ts <- temp %>% 
  as_tsibble(key = NULL, index = date) %>%
  fill_gaps()
```

### Annual Average Daily Temperature
```{r}
# annual stats
temp_annual <- temp %>% 
  group_by(year) %>% 
  summarize(
    mean_tmax = mean(TMAX, na.rm = TRUE),
    max_tmax = max(TMAX, na.rm = TRUE),
    mean_tmin = mean(TMIN, na.rm = TRUE),
    min_tmin = min(TMIN, na.rm = TRUE),
    count = n()
  )

# annual plots - mean
ggplot(data = temp_annual)+
  geom_point(aes(x = year, y = mean_tmax), color = "red") +
  scale_y_continuous(limits = c(min(temp_annual$mean_tmin), max(temp_annual$mean_tmax)))+
  geom_point(aes(x = year, y = mean_tmin), color = "blue")+
  theme_bw() +
  labs(x = "Year",
       y = "Mean Daily Temperature",
       title = "Annual Average Daily Temperatures (Max + Min) at Chicago Midway Airport",
       subtitle = "1944 - 2020")

a1 = ggplot(data = temp_annual)+
  geom_point(aes(x = year, y = mean_tmax), color = "red") +
  scale_y_continuous(limits = c(min(temp_annual$mean_tmin), max(temp_annual$mean_tmax)))+
  geom_point(aes(x = year, y = mean_tmin), color = "blue")+
  theme_bw() +
  labs(x = "Year",
       y = "Mean Daily Temperature (ºC)",
       title = "Annual Average Daily Temperatures (Max + Min) at Chicago Midway Airport",
       subtitle = "1944 - 2020")

a1 = a1+stat_smooth(data = temp_annual, aes(x = year, y = mean_tmax), method = "lm", col="red")
a1
a1+stat_smooth(data = temp_annual, aes(x = year, y = mean_tmin), method = "lm", col = "blue")

ggsave("mean_daily_temp.jpg", height = 6, width = 8)

# linear regressions to get equation of trend line
mean_tmax_lm <- lm(mean_tmax~year, data = temp_annual)
summary(mean_tmax_lm)

# linear regression to get equation of trend line
mean_tmin_lm <- lm(mean_tmin~year, data = temp_annual)
summary(mean_tmin_lm)

# Mann Kendall
MannKendall(temp_annual$mean_tmax) # somewhat of a trend
MannKendall(temp_annual$mean_tmin) # pretty good trend
```

### Annual Max and Min Temperatures
```{r}
# annual plots - max + min
ggplot(data = temp_annual)+
  geom_point(aes(x = year, y = max_tmax), color = "red") +
  scale_y_continuous(limits = c(min(temp_annual$min_tmin), max(temp_annual$max_tmax)))+
  geom_point(aes(x = year, y = min_tmin), color = "blue")+
  theme_bw() +
  labs(x = "Year",
       y = "Maximum and Minimum Daily Temperature",
       title = "Annual Maximum and Minimum Daily Temperatures at Chicago Midway Airport",
       subtitle = "1944 - 2020")

a2 = ggplot(data = temp_annual)+
  geom_point(aes(x = year, y = max_tmax), color = "red") +
  scale_y_continuous(limits = c(min(temp_annual$min_tmin), max(temp_annual$max_tmax)))+
  geom_point(aes(x = year, y = min_tmin), color = "blue")+
  theme_bw() +
  labs(x = "Year",
       y = "Maximum and Minimum Daily Temperature",
       title = "Annual Maximum and Minimum Daily Temperatures at Chicago Midway Airport",
       subtitle = "1944 - 2020")

a2 = a2+stat_smooth(data = temp_annual, aes(x = year, y = max_tmax), method = "lm", col="red")
a2
a2+stat_smooth(data = temp_annual, aes(x = year, y = min_tmin), method = "lm", col = "blue")

ggsave("max_min_daily_temps.jpg", height = 6, width = 8)

# linear regressions to get equation of trend line
max_tmax_lm <- lm(max_tmax~year, data = temp_annual)
summary(max_tmax_lm)

# linear regression to get equation of trend line
min_tmin_lm <- lm(mean_tmin~year, data = temp_annual)
summary(min_tmin_lm)

# Mann-Kendall test to check for trend
library(Kendall)
MannKendall(temp_annual$max_tmax) # negative tau, not very strong trend
MannKendall(temp_annual$min_tmin) # positive tau, but very small - better but still not that strong of a trend
```

### Number of cold days (max temp < 0ºC)
```{r}
# annual counts of days with max temp below freezing
temp_cold <- temp %>% 
  filter(TMAX < 0) %>% 
  group_by(year) %>% 
  summarize(
    cold_days = n()
  )

# plot 
ggplot(data = temp_cold)+
  geom_point(aes(x = year, y = cold_days)) +
  theme_bw()+
  labs(x = "Year",
       y = "Number of Cold Days (Daily Max. Temp < 0 ºC)",
       title = "Number of Days Below Freezing per Year at Chicago Midway Airport",
       subtitle = "1944 - 2020")

a3 = ggplot(data = temp_cold)+
  geom_point(aes(x = year, y = cold_days)) +
  theme_bw()+
  labs(x = "Year",
       y = "Number of Cold Days (Daily Max. Temp < 0 ºC)",
       title = "Number of Days Below Freezing per Year at Chicago Midway Airport",
       subtitle = "1944 - 2020")

a3 = a3+stat_smooth(data = temp_cold, aes(x = year, y = cold_days), method = "lm", col="black")
a3

ggsave("below_freezing_days_per_yr.jpg", height = 6, width = 8)

# linear regressions to get equation of trend line
cold_days_lm <- lm(cold_days~year, data = temp_cold)
summary(cold_days_lm)

# Mann-Kendall test to check for trend
MannKendall(temp_cold$cold_days) 
```

### Number of "hot" (max daily temp > 32.22 ºC) and "extremely hot" (max daily temp > 37.78 ºC) days 

thresholds for "hot" and "extremely hot" days taken from this report on climate change in Midwest: [https://www.ucsusa.org/sites/default/files/2019-09/midwest-climate-impacts.pdf](https://www.ucsusa.org/sites/default/files/2019-09/midwest-climate-impacts.pdf)
- on page 15, under "urban heat days"
```{r}
# hot days per year
temp_hot <- temp %>% 
  filter(TMAX > 32.22) %>% 
  group_by(year) %>% 
  summarize(
    hot_days = n()
  )

ggplot(data = temp_hot)+
  geom_line(aes(x = year, y = hot_days))

temp_extremely_hot <- temp %>% 
  filter(TMAX > 37.78) %>% 
  group_by(year) %>% 
  summarize(
    extreme_hot_days = n()
  )

ggplot(data = temp_extremely_hot)+
  geom_line(aes(x = year, y = extreme_hot_days))


### NOT MUCH TO GO OFF HERE
```

### Other Temp analyses - monthly, seasonplots (probably not using)
```{r}
# monthly stats
temp_monthly <- temp %>% 
  group_by(decade, year, month) %>% 
  summarize(
    mean_tmax = mean(TMAX, na.rm = TRUE),
    max_tmax = max(TMAX, na.rm = TRUE),
    mean_tmin = mean(TMIN, na.rm= TRUE),
    min_tmin = min(TMIN, na.rm = TRUE),
    count = n()
  )

temp_monthly$year = factor(temp_monthly$year)
temp_monthly$decade = factor(temp_monthly$decade)

# monthly plots - mean max temp
ggplot(data = temp_monthly)+
  geom_line(aes(x = month, y= mean_tmax, color = year), show.legend = FALSE)+
  facet_wrap(~decade)

# monthly plots - mean min temp
ggplot(data = temp_monthly)+
  geom_line(aes(x = month, y= mean_tmin, color = year), show.legend = FALSE)

# seasonplot - max temp
temp_ts %>% 
  gg_season(y = TMAX)

temp_ts %>% 
  gg_season(y = TMIN)
```

